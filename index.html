<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerador de Or√ßamento El√©trico</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script src="config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .form-container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .header-with-logo {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .header-title {
      flex: 1;
    }

    .header-logo {
      max-width: 200px;
      max-height: 80px;
    }

    .header-logo img {
      width: 100%;
      height: auto;
      object-fit: contain;
    }

    h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 5px;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
    }

    /* Bot√µes de Importar/Exportar no topo */
    .top-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 2px dashed #667eea;
    }

    .top-actions-title {
      width: 100%;
      text-align: center;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }

    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }

    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title::before {
      content: "üìã";
      font-size: 24px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      font-weight: 600;
      color: #555;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .label-auto {
      color: #28a745;
      font-size: 12px;
      font-weight: normal;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background-color: #fff;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    input:disabled {
      background-color: #e9ecef;
      cursor: not-allowed;
      color: #495057;
      font-weight: bold;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
      font-family: Arial, sans-serif;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }

    table th,
    table td {
      padding: 10px;
      text-align: left;
      border: 1px solid #ddd;
    }

    table th {
      background-color: #667eea;
      color: white;
      font-weight: 600;
      font-size: 13px;
    }

    table input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .total-geral {
      margin-top: 15px;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
      text-align: right;
      font-size: 20px;
      font-weight: bold;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-whatsapp {
      background: #25D366;
      color: white;
    }

    .btn-warning {
      background: #ffc107;
      color: #212529;
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-add {
      background: #17a2b8;
      color: white;
      padding: 8px 16px;
      font-size: 12px;
      margin-top: 10px;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
    }

    .upload-section {
      margin-top: 15px;
    }

    .upload-button {
      display: inline-block;
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .upload-button:hover {
      background: #5568d3;
    }

    .photo-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .photo-item {
      position: relative;
      border: 2px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      aspect-ratio: 1;
    }

    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-item .remove-photo {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
    }

    .projeto-preview {
      margin-top: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
    }

    .projeto-preview img {
      max-width: 100%;
      border-radius: 8px;
    }

    .qrcode-container {
      text-align: center;
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .qrcode-container img {
      max-width: 200px;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      background: white;
    }

    .pdf-preview {
      display: none;
      max-width: 900px;
      margin: 30px auto;
      background: white;
      padding: 40px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    .pdf-header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 20px;
      align-items: start;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #333;
    }

    .pdf-logo {
      text-align: center;
    }

    .pdf-logo img {
      max-width: 180px;
      max-height: 80px;
      object-fit: contain;
    }

    .pdf-company-info h2 {
      font-size: 18px;
      color: #333;
      margin-bottom: 5px;
    }

    .pdf-company-info p {
      font-size: 12px;
      color: #666;
      line-height: 1.6;
      margin: 2px 0;
    }

    .pdf-orcamento-info {
      text-align: right;
    }

    .pdf-orcamento-number {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }

    .pdf-section {
      margin-bottom: 25px;
    }

    .pdf-section-title {
      font-size: 16px;
      font-weight: bold;
      color: #333 !important;
      background-color: #f0f0f0 !important;
      padding: 8px 12px;
      margin-bottom: 10px;
      border-radius: 5px;
      border-left: 4px solid #667eea;
    }

    .pdf-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }

    .pdf-table th,
    .pdf-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid #ddd;
    }

    .pdf-table th {
      background-color: #f0f0f0;
      font-weight: bold;
    }

    .pdf-table .total-row {
      font-weight: bold;
      background-color: #f8f9fa;
    }

    .pdf-info-box {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.8;
    }

    .pdf-qrcode {
      text-align: center;
      margin-top: 15px;
    }

    .pdf-qrcode img {
      max-width: 180px;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 8px;
      background: white;
    }

    .pdf-footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 2px solid #333;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      font-size: 12px;
    }

    .pdf-signature {
      text-align: center;
      padding-top: 40px;
      border-top: 2px solid #333;
      margin-top: 10px;
    }

    .pdf-photos {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .pdf-photos img {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    .pdf-photo-caption {
      text-align: center;
      font-size: 10px;
      color: #666;
      margin-top: 5px;
    }

    .pdf-projeto {
      margin-top: 15px;
      text-align: center;
    }

    .pdf-projeto img {
      max-width: 100%;
      border: 2px solid #ddd;
      border-radius: 8px;
    }

    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 400px;
      width: 90%;
    }

    .popup.active {
      display: block;
    }

    .popup h3 {
      color: #dc3545;
      margin-bottom: 15px;
    }

    .popup p {
      color: #666;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .popup-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }

    .overlay.active {
      display: block;
    }

    .loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsividade MOBILE */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .form-container {
        padding: 20px;
      }

      h1 {
        font-size: 22px;
      }

      .header-with-logo {
        flex-direction: column;
        text-align: center;
      }

      .header-logo {
        margin-top: 15px;
        max-width: 150px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .section {
        padding: 15px;
      }

      .section-title {
        font-size: 16px;
      }

      table {
        font-size: 11px;
      }

      table th,
      table td {
        padding: 6px;
      }

      .action-buttons,
      .top-actions {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .photo-preview {
        grid-template-columns: repeat(2, 1fr);
      }

      .pdf-preview {
        padding: 20px;
      }

      .pdf-header {
        grid-template-columns: 1fr;
        text-align: center;
      }

      .pdf-logo {
        order: -1;
      }

      .pdf-orcamento-info {
        text-align: center;
      }

      .pdf-footer {
        grid-template-columns: 1fr;
      }

      .pdf-photos {
        grid-template-columns: repeat(2, 1fr);
      }

      .total-geral {
        font-size: 16px;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-container {
      animation: fadeIn 0.5s ease;
    }

    @media print {
      body {
        background: white;
        padding: 0;
      }

      .form-container {
        box-shadow: none;
        border-radius: 0;
      }

      .action-buttons,
      .top-actions {
        display: none;
      }
    }

    /* Alerta de sucesso */
    .alert-success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
    }

    .alert-success.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }
  </style>
</head>
<body>
  <!-- Input oculto para importar arquivo -->
  <input type="file" id="importFileInput" accept=".json" style="display: none;">

  <div class="form-container" id="formContainer">
    <div class="header-with-logo">
      <div class="header-title">
        <h1>‚ö° Gerador de Or√ßamento El√©trico</h1>
        <p class="subtitle">Preencha os dados abaixo para gerar seu or√ßamento profissional</p>
      </div>
      <div class="header-logo" id="headerLogo"></div>
    </div>

    <!-- BOT√ïES DE IMPORTAR/EXPORTAR -->
    <div class="top-actions">
      <div class="top-actions-title">üíæ Salvar e Carregar Or√ßamentos</div>
      <button class="btn btn-warning" onclick="exportarOrcamento()">
        üì§ EXPORTAR Or√ßamento
      </button>
      <button class="btn btn-info" onclick="document.getElementById('importFileInput').click()">
        üì• IMPORTAR Or√ßamento
      </button>
    </div>

    <div class="alert-success" id="alertSuccess"></div>

    <!-- SE√á√ÉO 1: DADOS DO PRESTADOR -->
    <div class="section">
      <div class="section-title">Dados do Prestador</div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Nome Completo *</label>
          <input type="text" id="prestadorNome" placeholder="Seu nome completo" required>
        </div>
        <div class="form-group">
          <label>CPF/CNPJ *</label>
          <input type="text" id="prestadorCpfCnpj" placeholder="000.000.000-00" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="prestadorEmail" placeholder="seu@email.com">
        </div>
        <div class="form-group">
          <label>Telefone *</label>
          <input type="tel" id="prestadorTelefone" placeholder="(85) 98765-4321" required>
        </div>
      </div>
    </div>

    <!-- SE√á√ÉO 2: DADOS DO CLIENTE -->
    <div class="section">
      <div class="section-title">Dados do Cliente</div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Nome/Raz√£o Social *</label>
          <input type="text" id="clienteNome" placeholder="Nome do cliente" required>
        </div>
        <div class="form-group">
          <label>CPF/CNPJ * <span class="label-auto">(gera n¬∫ or√ßamento)</span></label>
          <input type="text" id="clienteCpfCnpj" placeholder="00.000.000/0000-00" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Telefone Principal *</label>
          <input type="tel" id="clienteTelefone1" placeholder="(85) 98765-4321" required>
        </div>
        <div class="form-group">
          <label>Telefone Secund√°rio</label>
          <input type="tel" id="clienteTelefone2" placeholder="(85) 3456-7890">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="clienteEmail" placeholder="cliente@email.com">
        </div>
        <div class="form-group">
          <label>Nome do Contato Principal</label>
          <input type="text" id="clienteContato" placeholder="Nome da pessoa de contato">
        </div>
      </div>

      <div class="form-group">
        <label>Endere√ßo Completo</label>
        <input type="text" id="clienteEndereco" placeholder="Rua, n√∫mero, bairro, cidade-UF, CEP">
      </div>
    </div>

    <!-- SE√á√ÉO 3: INFORMA√á√ïES DO OR√áAMENTO -->
    <div class="section">
      <div class="section-title">Informa√ß√µes do Or√ßamento</div>
      
      <div class="form-row">
        <div class="form-group">
          <label>N√∫mero do Or√ßamento * <span class="label-auto">(gerado automaticamente)</span></label>
          <input type="text" id="orcamentoNumero" placeholder="Ser√° gerado automaticamente" disabled required>
        </div>
        <div class="form-group">
          <label>Data *</label>
          <input type="date" id="orcamentoData" required>
        </div>
      </div>

      <div class="form-group">
        <label>Local da Obra/Instala√ß√£o</label>
        <input type="text" id="localObra" placeholder="Endere√ßo onde ser√° realizado o servi√ßo">
      </div>
    </div>

    <!-- SE√á√ÉO 4: SERVI√áOS -->
    <div class="section">
      <div class="section-title">Servi√ßos</div>
      
      <div class="table-container">
        <table id="servicosTable">
          <thead>
            <tr>
              <th style="width: 50%">Descri√ß√£o do Servi√ßo</th>
              <th style="width: 15%">Pre√ßo Unit. (R$)</th>
              <th style="width: 10%">Qtd.</th>
              <th style="width: 20%">Total (R$)</th>
              <th style="width: 5%">A√ß√£o</th>
            </tr>
          </thead>
          <tbody id="servicosBody">
            <tr>
              <td><input type="text" placeholder="Ex: Instala√ß√£o de padr√£o de medi√ß√£o" class="servico-desc"></td>
              <td><input type="number" step="0.01" placeholder="0.00" class="servico-preco"></td>
              <td><input type="number" placeholder="1" class="servico-qtd" value="1"></td>
              <td><input type="text" readonly class="servico-total" style="background: #f0f0f0; font-weight: bold;"></td>
              <td><button class="btn btn-danger" onclick="removeRow(this)" style="padding: 5px 10px; font-size: 11px;">‚úï</button></td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <button class="btn btn-add" onclick="addServico()">+ Adicionar Servi√ßo</button>
      
      <div class="total-geral" id="totalServicos" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        üü¢ TOTAL SERVI√áOS: R$ 0,00
      </div>
      
      <div class="form-group" style="margin-top: 15px;">
        <label>Observa√ß√µes sobre os Servi√ßos</label>
        <textarea id="servicosObs" placeholder="Detalhes adicionais sobre os servi√ßos a serem realizados..."></textarea>
      </div>
    </div>

    <!-- SE√á√ÉO 5: MATERIAIS E EQUIPAMENTOS -->
    <div class="section">
      <div class="section-title">Materiais e Equipamentos</div>
      
      <div class="table-container">
        <table id="materiaisTable">
          <thead>
            <tr>
              <th style="width: 50%">Descri√ß√£o do Material</th>
              <th style="width: 15%">Pre√ßo Unit. (R$)</th>
              <th style="width: 10%">Qtd.</th>
              <th style="width: 20%">Total (R$)</th>
              <th style="width: 5%">A√ß√£o</th>
            </tr>
          </thead>
          <tbody id="materiaisBody">
            <tr>
              <td><input type="text" placeholder="Ex: Caixa de prote√ß√£o geral (CPG)" class="material-desc"></td>
              <td><input type="number" step="0.01" placeholder="0.00" class="material-preco"></td>
              <td><input type="number" placeholder="1" class="material-qtd" value="1"></td>
              <td><input type="text" readonly class="material-total" style="background: #f0f0f0; font-weight: bold;"></td>
              <td><button class="btn btn-danger" onclick="removeRow(this)" style="padding: 5px 10px; font-size: 11px;">‚úï</button></td>
            </tr>
          </tbody>
        </table>
      </div>
      <button class="btn btn-add" onclick="addMaterial()">+ Adicionar Material</button>

      <div class="total-geral" id="totalMateriais" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">
        üîµ TOTAL MATERIAIS: R$ 0,00
      </div>

      <div class="total-geral" id="totalGeralFinal" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 24px; margin-top: 20px;">
        üü£ TOTAL GERAL: R$ 0,00
      </div>

      <div class="form-group" style="margin-top: 15px;">
        <label>Observa√ß√µes sobre Materiais</label>
        <textarea id="materiaisObs" placeholder="Informa√ß√µes adicionais sobre materiais, marcas, garantias..."></textarea>
      </div>
    </div>

    <!-- SE√á√ÉO 6: PAGAMENTO -->
    <div class="section">
      <div class="section-title">Condi√ß√µes de Pagamento</div>
      
      <div class="form-group">
        <label>Meios de Pagamento Aceitos *</label>
        <input type="text" id="pagamentoMeios" placeholder="Ex: Transfer√™ncia banc√°ria, PIX, dinheiro, cart√£o" required>
      </div>

      <div class="form-group">
        <label>Condi√ß√µes de Pagamento *</label>
        <textarea id="pagamentoCondicoes" placeholder="Ex: 50% de entrada + 50% ap√≥s conclus√£o&#10;50% de entrada na aprova√ß√£o + 50% no faturamento referente ao material&#10;10% de entrada no in√≠cio da obra para custear gastos" required></textarea>
      </div>

      <div class="form-group">
        <label>Validade do Or√ßamento (dias)</label>
        <input type="number" id="orcamentoValidade" placeholder="30" value="30">
      </div>

      <div class="qrcode-container" id="qrcodeContainer">
        <p style="font-weight: bold; margin-bottom: 10px;">Pagamento via PIX:</p>
        <div id="qrcodeDisplay"></div>
      </div>
    </div>

    <!-- SE√á√ÉO 7: GARANTIA -->
    <div class="section">
      <div class="section-title">Garantia</div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Per√≠odo de Garantia *</label>
          <input type="text" id="garantiaPeriodo" placeholder="Ex: 12 meses" required>
        </div>
        <div class="form-group">
          <label>Cobertura</label>
          <input type="text" id="garantiaCobertura" placeholder="Ex: Defeitos de fabrica√ß√£o, instala√ß√£o">
        </div>
      </div>

      <div class="form-group">
        <label>Condi√ß√µes da Garantia *</label>
        <textarea id="garantiaCondicoes" placeholder="Ex: A partir da entrega dos produtos&#10;Cobertura: defeito de fabrica√ß√£o&#10;90 dias para servi√ßos e instala√ß√µes&#10;Para acionar a garantia entrar em contato pelo telefone..." required></textarea>
      </div>
    </div>

    <!-- SE√á√ÉO 8: PROJETO EL√âTRICO -->
    <div class="section">
      <div class="section-title">Projeto El√©trico (Opcional)</div>
      
      <div class="upload-section">
        <input type="file" id="projetoInput" accept="image/*,.pdf" style="display: none;">
        <label for="projetoInput" class="upload-button">
          üìê Adicionar Projeto El√©trico
        </label>
        <p style="font-size: 12px; color: #666; margin-top: 10px;">
          Adicione a imagem ou PDF do projeto el√©trico (se houver)
        </p>
        <div class="projeto-preview" id="projetoPreview"></div>
      </div>
    </div>

    <!-- SE√á√ÉO 9: ANEXO DE FOTOS -->
    <div class="section">
      <div class="section-title">Anexo de Fotos do Local</div>
      
      <div class="upload-section">
        <input type="file" id="photoInput" accept="image/*" multiple style="display: none;">
        <label for="photoInput" class="upload-button">
          üì∑ Adicionar Fotos do Local
        </label>
        <p style="font-size: 12px; color: #666; margin-top: 10px;">
          Adicione fotos do local da instala√ß√£o, materiais ou equipamentos
        </p>
        <div class="photo-preview" id="photoPreview"></div>
      </div>
    </div>

    <!-- BOT√ïES DE A√á√ÉO -->
    <div class="action-buttons">
      <button class="btn btn-primary" onclick="gerarPreview()">
        üìã Gerar Preview
      </button>
      <button class="btn btn-success" id="pdfButton" onclick="gerarPDF()">
        üíæ Salvar PDF
      </button>
      <button class="btn btn-whatsapp" id="whatsappButton" onclick="enviarWhatsApp()" disabled>
        üì± Enviar WhatsApp
      </button>
      <button class="btn btn-danger" onclick="limparFormulario()">
        üóëÔ∏è Limpar Tudo
      </button>
    </div>
  </div>

  <div class="pdf-preview" id="pdfPreview"></div>

  <div class="overlay" id="overlay"></div>
  <div class="popup" id="popup">
    <h3 id="popupTitle">Aten√ß√£o!</h3>
    <p id="popupMessage"></p>
    <div class="popup-buttons">
      <button class="btn btn-primary" onclick="fecharPopup()">OK</button>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>

  <script>
    // Vari√°veis globais
    let pdfSalvo = false;
    let fotosCarregadas = [];
    let projetoEletrico = null;
    let logoCarregada = false;
    let qrcodeCarregado = false;

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
      carregarDadosPrestador();
      carregarLogo();
      carregarQRCode();
      
      document.getElementById('orcamentoData').valueAsDate = new Date();
      document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
      document.getElementById('projetoInput').addEventListener('change', handleProjetoUpload);
      
      // Event listener para gerar n√∫mero do or√ßamento automaticamente
      document.getElementById('clienteCpfCnpj').addEventListener('input', gerarNumeroOrcamento);
      
      // Event listener para importar arquivo
      document.getElementById('importFileInput').addEventListener('change', importarOrcamento);
      
      // Inicializar listeners de c√°lculo
      attachServicosListeners();
      attachMateriaisListeners();
    });

    // FUN√á√ÉO: Gerar n√∫mero do or√ßamento automaticamente
    function gerarNumeroOrcamento() {
      const cpf = document.getElementById('clienteCpfCnpj').value.replace(/\D/g, '');
      
      if (cpf.length >= 5) {
        const cinco_digitos = cpf.substring(0, 5);
        const agora = new Date();
        const data = String(agora.getDate()).padStart(2, '0') + 
                     String(agora.getMonth() + 1).padStart(2, '0') + 
                     agora.getFullYear();
        const hora = String(agora.getHours()).padStart(2, '0') + 
                     String(agora.getMinutes()).padStart(2, '0');
        
        const numeroOrcamento = `${cinco_digitos}-${data}-${hora}`;
        document.getElementById('orcamentoNumero').value = numeroOrcamento;
      }
    }

function exportarOrcamento() {

    const clienteNome = getValorSeguro('clienteNome');
    if (!clienteNome.trim()) {
        mostrarPopup('Aten√ß√£o!', 'Preencha pelo menos o nome do cliente!');
        return;
    }

    const dados = {
        versao: '2.0',
        dataExportacao: new Date().toISOString(),

        prestador: {
            nome: getValorSeguro('prestadorNome'),
            cpfCnpj: getValorSeguro('prestadorCpfCnpj'),
            email: getValorSeguro('prestadorEmail'),
            telefone: getValorSeguro('prestadorTelefone'),
            endereco: getValorSeguro('prestadorEndereco')
        },

        cliente: {
            nome: getValorSeguro('clienteNome'),
            cpfCnpj: getValorSeguro('clienteCpfCnpj'),
            telefone1: getValorSeguro('clienteTelefone1'),
            telefone2: getValorSeguro('clienteTelefone2'),
            email: getValorSeguro('clienteEmail'),
            contato: getValorSeguro('clienteContato'),
            endereco: getValorSeguro('clienteEndereco')
        },

        orcamento: {
            numero: getValorSeguro('orcamentoNumero'),
            data: getValorSeguro('orcamentoData'),
            localObra: getValorSeguro('localObra'),
            validade: getValorSeguro('orcamentoValidade')
        },

        servicos: [],
        servicosObs: getValorSeguro('servicosObs'),

        materiais: [],
        materiaisObs: getValorSeguro('materiaisObs'),

        pagamento: {
            meios: getValorSeguro('pagamentoMeios'),
            condicoes: getValorSeguro('pagamentoCondicoes')
        },

        garantia: {
            periodo: getValorSeguro('garantiaPeriodo'),
            cobertura: getValorSeguro('garantiaCobertura'),
            condicoes: getValorSeguro('garantiaCondicoes')
        },

        projetoEletrico: projetoEletrico ? { 
            name: projetoEletrico.name, 
            src: projetoEletrico.src 
        } : null,

        fotos: fotosCarregadas
    };

    // CORRE√á√ÉO DOS SERVI√áOS
    document.querySelectorAll('#servicosBody tr').forEach(row => {
        const desc = row.querySelector('.servico-desc').value.trim();
        if (desc) {
            dados.servicos.push({
                descricao: desc,
                preco: row.querySelector('.servico-preco').value || "0",
                quantidade: row.querySelector('.servico-qtd').value || "1",
                total: row.querySelector('.servico-total').value || "0"
            });
        }
    });

    // CORRE√á√ÉO DOS MATERIAIS
    document.querySelectorAll('#materiaisBody tr').forEach(row => {
        const desc = row.querySelector('.material-desc').value.trim();
        if (desc) {
            dados.materiais.push({
                descricao: desc,
                preco: row.querySelector('.material-preco').value || "0",
                quantidade: row.querySelector('.material-qtd').value || "1",
                total: row.querySelector('.material-total').value || "0"
            });
        }
    });

    const jsonString = JSON.stringify(dados, null, 2);

    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const fileName = `ORCAMENTO_${dados.orcamento.numero}_${clienteNome.replace(/\s+/g, '_')}.json`;

    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    a.click();

    URL.revokeObjectURL(url);

    mostrarPopup("Sucesso!", "Or√ßamento exportado com sucesso!");
}

function importarOrcamento(event) {

    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {

        const dados = JSON.parse(e.target.result);

        // PRESTADOR
        document.getElementById('prestadorNome').value = dados.prestador.nome;
        document.getElementById('prestadorCpfCnpj').value = dados.prestador.cpfCnpj;
        document.getElementById('prestadorEmail').value = dados.prestador.email;
        document.getElementById('prestadorTelefone').value = dados.prestador.telefone;
        document.getElementById('prestadorEndereco').value = dados.prestador.endereco;

        // CLIENTE
        document.getElementById('clienteNome').value = dados.cliente.nome;
        document.getElementById('clienteCpfCnpj').value = dados.cliente.cpfCnpj;
        document.getElementById('clienteTelefone1').value = dados.cliente.telefone1;
        document.getElementById('clienteTelefone2').value = dados.cliente.telefone2;
        document.getElementById('clienteEmail').value = dados.cliente.email;
        document.getElementById('clienteContato').value = dados.cliente.contato;
        document.getElementById('clienteEndereco').value = dados.cliente.endereco;

        // OR√áAMENTO
        document.getElementById('orcamentoNumero').value = dados.orcamento.numero;
        document.getElementById('orcamentoData').value = dados.orcamento.data;
        document.getElementById('localObra').value = dados.orcamento.localObra;
        document.getElementById('orcamentoValidade').value = dados.orcamento.validade;

        // SERVI√áOS
        const servicosBody = document.getElementById('servicosBody');
        servicosBody.innerHTML = "";

        dados.servicos.forEach(s => {
            const row = servicosBody.insertRow();
            row.innerHTML = `
                <td><input class="servico-desc" value="${s.descricao}"></td>
                <td><input class="servico-preco" value="${s.preco}"></td>
                <td><input class="servico-qtd" value="${s.quantidade}"></td>
                <td><input class="servico-total" value="${s.total}" readonly></td>
                <td><button class="btn btn-danger" onclick="removeRow(this)">‚úï</button></td>
            `;
        });

        document.getElementById('servicosObs').value = dados.servicosObs;

        // MATERIAIS
        const materiaisBody = document.getElementById('materiaisBody');
        materiaisBody.innerHTML = "";

        dados.materiais.forEach(m => {
            const row = materiaisBody.insertRow();
            row.innerHTML = `
                <td><input class="material-desc" value="${m.descricao}"></td>
                <td><input class="material-preco" value="${m.preco}"></td>
                <td><input class="material-qtd" value="${m.quantidade}"></td>
                <td><input class="material-total" value="${m.total}" readonly></td>
                <td><button class="btn btn-danger" onclick="removeRow(this)">‚úï</button></td>
            `;
        });

        document.getElementById('materiaisObs').value = dados.materiaisObs;

        // PROJETO ELETRICO
        if (dados.projetoEletrico) {
            projetoEletrico = dados.projetoEletrico;

            document.getElementById("projetoPreview").innerHTML = `
                <img src="${projetoEletrico.src}" style="max-width:100%">
                <p>${projetoEletrico.name}</p>
            `;
        }

        // FOTOS
        fotosCarregadas = dados.fotos || [];
        atualizarPreviewFotos();

        calcularTotais();

        mostrarPopup("Sucesso!", "Or√ßamento importado com sucesso!");
    }

    reader.readAsText(file);
}

    // FUN√á√ÉO: Mostrar alerta de sucesso
    function mostrarAlerta(mensagem) {
      const alert = document.getElementById('alertSuccess');
      alert.textContent = mensagem;
      alert.classList.add('show');
      setTimeout(() => {
        alert.classList.remove('show');
      }, 5000);
    }

    // Carrega dados do prestador do arquivo config.js
    function carregarDadosPrestador() {
      try {
        if (typeof dadosPrestador !== 'undefined') {
          document.getElementById('prestadorNome').value = dadosPrestador.nome || '';
          document.getElementById('prestadorCpfCnpj').value = dadosPrestador.cpfCnpj || '';
          document.getElementById('prestadorEmail').value = dadosPrestador.email || '';
          document.getElementById('prestadorTelefone').value = dadosPrestador.telefone || '';
          document.getElementById('prestadorEndereco').value = dadosPrestador.endereco || '';
          
          if (typeof textosPadrao !== 'undefined') {
            document.getElementById('garantiaPeriodo').value = textosPadrao.garantiaPeriodo || '';
            document.getElementById('garantiaCobertura').value = textosPadrao.garantiaCobertura || '';
            document.getElementById('garantiaCondicoes').value = textosPadrao.garantiaCondicoes || '';
            document.getElementById('pagamentoMeios').value = textosPadrao.meiosPagamento || '';
            document.getElementById('pagamentoCondicoes').value = textosPadrao.condicoesPagamento || '';
          }
        }
      } catch (error) {
        console.log('Arquivo config.js n√£o encontrado ou dados n√£o dispon√≠veis');
      }
    }

    function carregarLogo() {
      try {
        if (typeof arquivosImagem !== 'undefined' && arquivosImagem.logo) {
          const img = document.createElement('img');
          img.src = arquivosImagem.logo;
          img.alt = 'Logo da Empresa';
          img.onerror = function() {
            console.log('Logo n√£o encontrada: ' + arquivosImagem.logo);
          };
          img.onload = function() {
            document.getElementById('headerLogo').appendChild(img);
            logoCarregada = true;
          };
        }
      } catch (error) {
        console.log('Logo n√£o configurada');
      }
    }

    function carregarQRCode() {
      try {
        if (typeof arquivosImagem !== 'undefined' && arquivosImagem.qrcodePix) {
          const img = document.createElement('img');
          img.src = arquivosImagem.qrcodePix;
          img.alt = 'QR Code PIX';
          img.onerror = function() {
            console.log('QR Code n√£o encontrado: ' + arquivosImagem.qrcodePix);
            document.getElementById('qrcodeContainer').style.display = 'none';
          };
          img.onload = function() {
            document.getElementById('qrcodeDisplay').appendChild(img);
            qrcodeCarregado = true;
          };
        } else {
          document.getElementById('qrcodeContainer').style.display = 'none';
        }
      } catch (error) {
        console.log('QR Code n√£o configurado');
        document.getElementById('qrcodeContainer').style.display = 'none';
      }
    }

    function addServico() {
      const tbody = document.getElementById('servicosBody');
      const newRow = tbody.insertRow();
      newRow.innerHTML = `
        <td><input type="text" placeholder="Descri√ß√£o do servi√ßo" class="servico-desc"></td>
        <td><input type="number" step="0.01" placeholder="0.00" class="servico-preco"></td>
        <td><input type="number" placeholder="1" class="servico-qtd" value="1"></td>
        <td><input type="text" readonly class="servico-total" style="background: #f0f0f0; font-weight: bold;"></td>
        <td><button class="btn btn-danger" onclick="removeRow(this)" style="padding: 5px 10px; font-size: 11px;">‚úï</button></td>
      `;
      attachServicosListeners();
    }

    function addMaterial() {
      const tbody = document.getElementById('materiaisBody');
      const newRow = tbody.insertRow();
      newRow.innerHTML = `
        <td><input type="text" placeholder="Descri√ß√£o do material" class="material-desc"></td>
        <td><input type="number" step="0.01" placeholder="0.00" class="material-preco"></td>
        <td><input type="number" placeholder="1" class="material-qtd" value="1"></td>
        <td><input type="text" readonly class="material-total" style="background: #f0f0f0; font-weight: bold;"></td>
        <td><button class="btn btn-danger" onclick="removeRow(this)" style="padding: 5px 10px; font-size: 11px;">‚úï</button></td>
      `;
      attachMateriaisListeners();
    }

    function removeRow(btn) {
      const row = btn.closest('tr');
      row.remove();
      calcularTotais();
    }

    function calcularTotais() {
      // Calcular Total Servi√ßos
      const servicosRows = document.querySelectorAll('#servicosBody tr');
      let totalServicos = 0;
      
      servicosRows.forEach(row => {
        const preco = parseFloat(row.querySelector('.servico-preco').value) || 0;
        const qtd = parseFloat(row.querySelector('.servico-qtd').value) || 0;
        const total = preco * qtd;
        row.querySelector('.servico-total').value = total.toFixed(2);
        totalServicos += total;
      });
      
      // Calcular Total Materiais
      const materiaisRows = document.querySelectorAll('#materiaisBody tr');
      let totalMateriais = 0;
      
      materiaisRows.forEach(row => {
        const preco = parseFloat(row.querySelector('.material-preco').value) || 0;
        const qtd = parseFloat(row.querySelector('.material-qtd').value) || 0;
        const total = preco * qtd;
        row.querySelector('.material-total').value = total.toFixed(2);
        totalMateriais += total;
      });
      
      // Calcular Total Geral
      const totalGeral = totalServicos + totalMateriais;
      
      // Atualizar displays
      document.getElementById('totalServicos').textContent = 
        `üü¢ TOTAL SERVI√áOS: R$ ${totalServicos.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      
      document.getElementById('totalMateriais').textContent = 
        `üîµ TOTAL MATERIAIS: R$ ${totalMateriais.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      
      document.getElementById('totalGeralFinal').textContent = 
        `üü£ TOTAL GERAL: R$ ${totalGeral.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    // Attach listeners para c√°lculo autom√°tico
    function attachServicosListeners() {
      document.querySelectorAll('.servico-preco, .servico-qtd').forEach(input => {
        input.addEventListener('input', calcularTotais);
      });
    }

    function attachMateriaisListeners() {
      document.querySelectorAll('.material-preco, .material-qtd').forEach(input => {
        input.addEventListener('input', calcularTotais);
      });
    }

    function handlePhotoUpload(event) {
      const files = event.target.files;
      const preview = document.getElementById('photoPreview');
      
      for (let file of files) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const photoData = {
            src: e.target.result,
            name: file.name
          };
          fotosCarregadas.push(photoData);
          
          const photoItem = document.createElement('div');
          photoItem.className = 'photo-item';
          photoItem.innerHTML = `
            <img src="${e.target.result}" alt="${file.name}">
            <button class="remove-photo" onclick="removePhoto(${fotosCarregadas.length - 1})">‚úï</button>
          `;
          preview.appendChild(photoItem);
        };
        reader.readAsDataURL(file);
      }
    }

    function handleProjetoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const preview = document.getElementById('projetoPreview');
      const reader = new FileReader();
      
      reader.onload = function(e) {
        projetoEletrico = {
          src: e.target.result,
          name: file.name
        };
        
        preview.innerHTML = `
          <img src="${e.target.result}" alt="Projeto El√©trico" style="max-width: 100%;">
          <p style="margin-top: 10px; font-weight: bold;">${file.name}</p>
          <button class="btn btn-danger" onclick="removerProjeto()" style="margin-top: 10px;">Remover Projeto</button>
        `;
      };
      
      reader.readAsDataURL(file);
    }

    function removerProjeto() {
      projetoEletrico = null;
      document.getElementById('projetoPreview').innerHTML = '';
      document.getElementById('projetoInput').value = '';
    }

    function removePhoto(index) {
      fotosCarregadas.splice(index, 1);
      const preview = document.getElementById('photoPreview');
      preview.innerHTML = '';
      fotosCarregadas.forEach((photo, idx) => {
        const photoItem = document.createElement('div');
        photoItem.className = 'photo-item';
        photoItem.innerHTML = `
          <img src="${photo.src}" alt="${photo.name}">
          <button class="remove-photo" onclick="removePhoto(${idx})">‚úï</button>
        `;
        preview.appendChild(photoItem);
      });
    }

    function validarCampos() {
      const camposObrigatorios = [
        { id: 'prestadorNome', nome: 'Nome do Prestador' },
        { id: 'prestadorCpfCnpj', nome: 'CPF/CNPJ do Prestador' },
        { id: 'prestadorTelefone', nome: 'Telefone do Prestador' },
        { id: 'clienteNome', nome: 'Nome do Cliente' },
        { id: 'clienteCpfCnpj', nome: 'CPF/CNPJ do Cliente' },
        { id: 'clienteTelefone1', nome: 'Telefone do Cliente' },
        { id: 'orcamentoNumero', nome: 'N√∫mero do Or√ßamento' },
        { id: 'orcamentoData', nome: 'Data do Or√ßamento' },
        { id: 'pagamentoMeios', nome: 'Meios de Pagamento' },
        { id: 'pagamentoCondicoes', nome: 'Condi√ß√µes de Pagamento' },
        { id: 'garantiaPeriodo', nome: 'Per√≠odo de Garantia' },
        { id: 'garantiaCondicoes', nome: 'Condi√ß√µes da Garantia' }
      ];

      const camposFaltando = [];
      
      for (let campo of camposObrigatorios) {
        const elemento = document.getElementById(campo.id);
        if (!elemento.value.trim()) {
          camposFaltando.push(campo.nome);
        }
      }

      const servicos = document.querySelectorAll('#servicosBody tr');
      let temServico = false;
      servicos.forEach(row => {
        if (row.querySelector('.servico-desc').value.trim()) {
          temServico = true;
        }
      });

      if (!temServico) {
        camposFaltando.push('Pelo menos um servi√ßo deve ser adicionado');
      }

      if (camposFaltando.length > 0) {
        mostrarPopup('Campos Obrigat√≥rios', 
          'Por favor, preencha os seguintes campos:\n\n‚Ä¢ ' + 
          camposFaltando.join('\n‚Ä¢ '));
        return false;
      }

      return true;
    }

    function isMobile() {
      return window.innerWidth <= 768;
    }

    function gerarPreview() {
      if (!validarCampos()) return;

      const preview = document.getElementById('pdfPreview');
      let html = '';

      html += `
        <div class="pdf-header">
          <div class="pdf-company-info">
            <h2>${document.getElementById('prestadorNome').value}</h2>
            <p><strong>CPF/CNPJ:</strong> ${document.getElementById('prestadorCpfCnpj').value}</p>
            ${document.getElementById('prestadorEmail').value ? `<p><strong>Email:</strong> ${document.getElementById('prestadorEmail').value}</p>` : ''}
            <p><strong>Telefone:</strong> ${document.getElementById('prestadorTelefone').value}</p>
          </div>
          ${logoCarregada ? `<div class="pdf-logo"><img src="${arquivosImagem.logo}" alt="Logo"></div>` : '<div></div>'}
          <div class="pdf-orcamento-info">
            <div class="pdf-orcamento-number">Or√ßamento ${document.getElementById('orcamentoNumero').value}</div>
            <p><strong>Data:</strong> ${formatarData(document.getElementById('orcamentoData').value)}</p>
            ${document.getElementById('localObra').value ? `<p><strong>Local:</strong> ${document.getElementById('localObra').value}</p>` : ''}
          </div>
        </div>
      `;

      html += `
        <div class="pdf-section">
          <div class="pdf-section-title">Cliente</div>
          <div class="pdf-info-box">
            <p><strong>${document.getElementById('clienteNome').value}</strong></p>
            <p><strong>CPF/CNPJ:</strong> ${document.getElementById('clienteCpfCnpj').value}</p>
            <p><strong>Telefone:</strong> ${document.getElementById('clienteTelefone1').value}</p>
            ${document.getElementById('clienteTelefone2').value ? `<p><strong>Telefone 2:</strong> ${document.getElementById('clienteTelefone2').value}</p>` : ''}
            ${document.getElementById('clienteEmail').value ? `<p><strong>Email:</strong> ${document.getElementById('clienteEmail').value}</p>` : ''}
            ${document.getElementById('clienteEndereco').value ? `<p><strong>Endere√ßo:</strong> ${document.getElementById('clienteEndereco').value}</p>` : ''}
            ${document.getElementById('clienteContato').value ? `<p><strong>Contato:</strong> ${document.getElementById('clienteContato').value}</p>` : ''}
          </div>
        </div>
      `;

      const servicos = [];
      let totalServicos = 0;
      document.querySelectorAll('#servicosBody tr').forEach(row => {
        const desc = row.querySelector('.servico-desc').value;
        if (desc.trim()) {
          const preco = parseFloat(row.querySelector('.servico-preco').value) || 0;
          const qtd = parseFloat(row.querySelector('.servico-qtd').value) || 0;
          const total = preco * qtd;
          totalServicos += total;
          servicos.push({ desc, preco, qtd, total });
        }
      });

      if (servicos.length > 0) {
        html += `
          <div class="pdf-section">
            <div class="pdf-section-title">Servi√ßos</div>
            <table class="pdf-table">
              <thead>
                <tr>
                  <th>Descri√ß√£o</th>
                  <th style="text-align: right;">Pre√ßo Unit.</th>
                  <th style="text-align: center;">Qtd.</th>
                  <th style="text-align: right;">Total</th>
                </tr>
              </thead>
              <tbody>
        `;

        servicos.forEach(s => {
          html += `
            <tr>
              <td>${s.desc}</td>
              <td style="text-align: right;">R$ ${s.preco.toFixed(2)}</td>
              <td style="text-align: center;">${s.qtd}</td>
              <td style="text-align: right;">R$ ${s.total.toFixed(2)}</td>
            </tr>
          `;
        });

        html += `
                <tr class="total-row" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                  <td colspan="3" style="text-align: right;"><strong>üü¢ TOTAL SERVI√áOS</strong></td>
                  <td style="text-align: right;"><strong>R$ ${totalServicos.toFixed(2)}</strong></td>
                </tr>
              </tbody>
            </table>
        `;

        if (document.getElementById('servicosObs').value) {
          html += `<div class="pdf-info-box" style="margin-top: 10px;">
            <p><strong>Observa√ß√µes:</strong></p>
            <p>${document.getElementById('servicosObs').value.replace(/\n/g, '<br>')}</p>
          </div>`;
        }

        html += `</div>`;
      }

      const materiais = [];
      let totalMateriais = 0;
      document.querySelectorAll('#materiaisBody tr').forEach(row => {
        const desc = row.querySelector('.material-desc').value;
        if (desc.trim()) {
          const preco = parseFloat(row.querySelector('.material-preco').value) || 0;
          const qtd = parseFloat(row.querySelector('.material-qtd').value) || 0;
          const total = preco * qtd;
          totalMateriais += total;
          materiais.push({ desc, preco, qtd, total });
        }
      });

      if (materiais.length > 0) {
        html += `
          <div class="pdf-section">
            <div class="pdf-section-title">Materiais e Equipamentos</div>
            <table class="pdf-table">
              <thead>
                <tr>
                  <th>Descri√ß√£o</th>
                  <th style="text-align: right;">Pre√ßo Unit.</th>
                  <th style="text-align: center;">Qtd.</th>
                  <th style="text-align: right;">Total</th>
                </tr>
              </thead>
              <tbody>
        `;

        materiais.forEach((m, idx) => {
          html += `
            <tr>
              <td>${idx + 1}. ${m.desc}</td>
              <td style="text-align: right;">R$ ${m.preco.toFixed(2)}</td>
              <td style="text-align: center;">${m.qtd}</td>
              <td style="text-align: right;">R$ ${m.total.toFixed(2)}</td>
            </tr>
          `;
        });

        html += `
                <tr class="total-row" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white;">
                  <td colspan="3" style="text-align: right;"><strong>üîµ TOTAL MATERIAIS</strong></td>
                  <td style="text-align: right;"><strong>R$ ${totalMateriais.toFixed(2)}</strong></td>
                </tr>
              </tbody>
            </table>`;

        if (document.getElementById('materiaisObs').value) {
          html += `<div class="pdf-info-box" style="margin-top: 10px;">
            <p><strong>Observa√ß√µes:</strong></p>
            <p>${document.getElementById('materiaisObs').value.replace(/\n/g, '<br>')}</p>
          </div>`;
        }

        html += `</div>`;
      }

      // TOTAL GERAL (Servi√ßos + Materiais)
      const totalGeral = totalServicos + totalMateriais;
      if (totalGeral > 0) {
        html += `
          <div class="pdf-section" style="margin-top: 20px;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; text-align: right; font-size: 24px; font-weight: bold;">
              üü£ TOTAL GERAL: R$ ${totalGeral.toFixed(2)}
            </div>
          </div>
        `;
      }

      html += `
        <div class="pdf-section">
          <div class="pdf-section-title">Pagamento</div>
          <div class="pdf-info-box">
            <p><strong>Meios de pagamento:</strong></p>
            <p>${document.getElementById('pagamentoMeios').value}</p>
            <p style="margin-top: 10px;"><strong>Condi√ß√µes de pagamento:</strong></p>
            <p>${document.getElementById('pagamentoCondicoes').value.replace(/\n/g, '<br>')}</p>
            ${document.getElementById('orcamentoValidade').value ? `<p style="margin-top: 10px;"><strong>Validade:</strong> ${document.getElementById('orcamentoValidade').value} dias</p>` : ''}
          </div>
      `;

      if (qrcodeCarregado) {
        html += `
          <div class="pdf-qrcode">
            <p style="font-weight: bold; margin-bottom: 10px;">Pagamento via PIX:</p>
            <img src="${arquivosImagem.qrcodePix}" alt="QR Code PIX">
          </div>
        `;
      }

      html += `</div>`;

      html += `
        <div class="pdf-section">
          <div class="pdf-section-title">Garantia</div>
          <div class="pdf-info-box">
            <p><strong>Per√≠odo de garantia:</strong> ${document.getElementById('garantiaPeriodo').value}</p>
            ${document.getElementById('garantiaCobertura').value ? `<p><strong>Cobertura:</strong> ${document.getElementById('garantiaCobertura').value}</p>` : ''}
            <p style="margin-top: 10px;"><strong>Condi√ß√µes:</strong></p>
            <p>${document.getElementById('garantiaCondicoes').value.replace(/\n/g, '<br>')}</p>
          </div>
        </div>
      `;

      if (projetoEletrico) {
        html += `
          <div class="pdf-section">
            <div class="pdf-section-title">Projeto El√©trico</div>
            <div class="pdf-projeto">
              <img src="${projetoEletrico.src}" alt="Projeto El√©trico">
              <p style="margin-top: 10px; font-size: 12px; color: #666;">${projetoEletrico.name}</p>
            </div>
          </div>
        `;
      }

      if (fotosCarregadas.length > 0) {
        html += `
          <div class="pdf-section">
            <div class="pdf-section-title">Anexo - Fotos do Local</div>
            <div class="pdf-photos">
        `;

        fotosCarregadas.forEach((foto, idx) => {
          html += `
            <div>
              <img src="${foto.src}" alt="Foto ${idx + 1}">
              <p class="pdf-photo-caption">Foto ${idx + 1}</p>
            </div>
          `;
        });

        html += `</div></div>`;
      }

      html += `
        <div class="pdf-footer">
          <div>
            <p><strong>${document.getElementById('prestadorNome').value}</strong></p>
            <p>CPF/CNPJ: ${document.getElementById('prestadorCpfCnpj').value}</p>
            <div class="pdf-signature">Assinatura do Prestador</div>
          </div>
          <div>
            <p><strong>${document.getElementById('clienteNome').value}</strong></p>
            <p>CPF/CNPJ: ${document.getElementById('clienteCpfCnpj').value}</p>
            <div class="pdf-signature">Assinatura do Cliente</div>
          </div>
        </div>
      `;

      preview.innerHTML = html;
      preview.style.display = 'block';
      preview.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function gerarPDF() {
      if (!validarCampos()) return;
      gerarPreview();

      document.getElementById('loading').classList.add('active');

      const preview = document.getElementById('pdfPreview');
      const width = preview.offsetWidth;
      const height = preview.offsetHeight;

      const cliente = document.getElementById('clienteNome').value.replace(/\s+/g, '_');
      const numero = document.getElementById('orcamentoNumero').value.replace(/[\/\-\s]/g, '_');
      const data = document.getElementById('orcamentoData').value.split('-').reverse().join('_');
      const fileName = `ORCAMENTO_${numero}_${cliente}_${data}.PDF`.toUpperCase();

      let pdfConfig = {
        margin: [10, 10, 10, 10],
        filename: fileName,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: isMobile() ? 1.5 : 2,
          useCORS: true,
          logging: false
        },
        jsPDF: { 
          unit: 'px', 
          format: [width + 20, height + 20], 
          orientation: 'portrait'
        }
      };

      html2pdf().set(pdfConfig).from(preview).save().then(() => {
        document.getElementById('loading').classList.remove('active');

        const pdfButton = document.getElementById('pdfButton');
        pdfButton.textContent = '‚úÖ PDF J√Å SALVO';
        pdfButton.style.backgroundColor = '#28a745';
        pdfButton.disabled = true;
        pdfSalvo = true;

        document.getElementById('whatsappButton').disabled = false;

        mostrarPopup('Sucesso!', 'PDF gerado e salvo com sucesso!');
      });
    }

    function enviarWhatsApp() {
      if (!pdfSalvo) {
        mostrarPopup('Aten√ß√£o!', 'Voc√™ precisa salvar o PDF antes de enviar pelo WhatsApp!');
        return;
      }

      let mensagem = `üìã *OR√áAMENTO ${document.getElementById('orcamentoNumero').value}*\n\n`;
      mensagem += `üë§ *Cliente:* ${document.getElementById('clienteNome').value}\n`;
      mensagem += `üìÖ *Data:* ${formatarData(document.getElementById('orcamentoData').value)}\n\n`;
      
      let total = 0;
      document.querySelectorAll('#servicosBody tr').forEach(row => {
        const preco = parseFloat(row.querySelector('.servico-preco').value) || 0;
        const qtd = parseFloat(row.querySelector('.servico-qtd').value) || 0;
        total += preco * qtd;
      });
      
      if (total > 0) {
        mensagem += `üí∞ *Valor Total:* R$ ${total.toFixed(2)}\n\n`;
      }
      
      mensagem += `üìÑ O or√ßamento completo em PDF foi gerado e est√° anexo.\n\n`;
      mensagem += `Para mais informa√ß√µes, entre em contato:\n`;
      mensagem += `üìû ${document.getElementById('prestadorTelefone').value}`;

      const url = `https://wa.me/?text=${encodeURIComponent(mensagem)}`;
      window.open(url, '_blank');
    }

    function limparFormulario() {
      if (confirm('Tem certeza que deseja limpar todos os dados? Esta a√ß√£o n√£o pode ser desfeita.')) {
        const prestadorNome = document.getElementById('prestadorNome').value;
        const prestadorCpf = document.getElementById('prestadorCpfCnpj').value;
        const prestadorEmail = document.getElementById('prestadorEmail').value;
        const prestadorTelefone = document.getElementById('prestadorTelefone').value;
        const prestadorEndereco = document.getElementById('prestadorEndereco').value;
        
        document.getElementById('formContainer').querySelectorAll('input, textarea, select').forEach(el => {
          if (el.type !== 'file' && el.type !== 'button') {
            el.value = '';
          }
        });
        
        document.getElementById('prestadorNome').value = prestadorNome;
        document.getElementById('prestadorCpfCnpj').value = prestadorCpf;
        document.getElementById('prestadorEmail').value = prestadorEmail;
        document.getElementById('prestadorTelefone').value = prestadorTelefone;
        document.getElementById('prestadorEndereco').value = prestadorEndereco;
        
        carregarDadosPrestador();
        
        document.getElementById('servicosBody').innerHTML = `
          <tr>
            <td><input type="text" placeholder="Ex: Instala√ß√£o de padr√£o de medi√ß√£o" class="servico-desc"></td>
            <td><input type="text" placeholder="un." class="servico-unidade"></td>
            <td><input type="number" step="0.01" placeholder="0.00" class="servico-preco"></td>
            <td><input type="number" placeholder="1" class="servico-qtd" value="1"></td>
            <td><input type="text" readonly class="servico-total" style="background: #f0f0f0; font-weight: bold;"></td>
            <td><button class="btn btn-danger" onclick="removeRow(this)" style="padding: 5px 10px; font-size: 11px;">‚úï</button></td>
          </tr>
        `;
        
        document.getElementById('materiaisBody').innerHTML = `
          <tr>
            <td><input type="text" placeholder="Ex: Caixa de prote√ß√£o geral (CPG)" class="material-desc"></td>
            <td><input type="text" placeholder="01" class="material-qtd"></td>
            <td><input type="text" placeholder="Selado" class="material-espec"></td>
            <td><button class="btn btn-danger" onclick="removeRow(this)" style="padding: 5px 10px; font-size: 11px;">‚úï</button></td>
          </tr>
        `;

        fotosCarregadas = [];
        projetoEletrico = null;
        document.getElementById('photoPreview').innerHTML = '';
        document.getElementById('projetoPreview').innerHTML = '';

        document.getElementById('totalGeral').textContent = 'TOTAL GERAL: R$ 0,00';

        pdfSalvo = false;
        document.getElementById('pdfButton').textContent = 'üíæ Salvar PDF';
        document.getElementById('pdfButton').style.backgroundColor = '#28a745';
        document.getElementById('pdfButton').disabled = false;
        document.getElementById('whatsappButton').disabled = true;
        document.getElementById('pdfPreview').style.display = 'none';

        document.getElementById('orcamentoData').valueAsDate = new Date();
      }
    }

    function mostrarPopup(titulo, mensagem) {
      document.getElementById('popupTitle').textContent = titulo;
      document.getElementById('popupMessage').textContent = mensagem;
      document.getElementById('popup').classList.add('active');
      document.getElementById('overlay').classList.add('active');
    }

    function fecharPopup() {
      document.getElementById('popup').classList.remove('active');
      document.getElementById('overlay').classList.remove('active');
    }

    document.getElementById('overlay').addEventListener('click', fecharPopup);

    function formatarData(dataISO) {
      if (!dataISO) return '';
      const [ano, mes, dia] = dataISO.split('-');
      return `${dia}/${mes}/${ano}`;
    }

    document.getElementById('prestadorTelefone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 11) value = value.slice(0, 11);
      if (value.length > 6) {
        value = `(${value.slice(0,2)}) ${value.slice(2,7)}-${value.slice(7)}`;
      } else if (value.length > 2) {
        value = `(${value.slice(0,2)}) ${value.slice(2)}`;
      }
      e.target.value = value;
    });

    document.getElementById('clienteTelefone1').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 11) value = value.slice(0, 11);
      if (value.length > 6) {
        value = `(${value.slice(0,2)}) ${value.slice(2,7)}-${value.slice(7)}`;
      } else if (value.length > 2) {
        value = `(${value.slice(0,2)}) ${value.slice(2)}`;
      }
      e.target.value = value;
    });

    document.getElementById('clienteTelefone2').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 11) value = value.slice(0, 11);
      if (value.length > 6) {
        value = `(${value.slice(0,2)}) ${value.slice(2,7)}-${value.slice(7)}`;
      } else if (value.length > 2) {
        value = `(${value.slice(0,2)}) ${value.slice(2)}`;
      }
      e.target.value = value;
    });

    // FORMATA√á√ÉO AUTOM√ÅTICA DE CPF/CNPJ - PRESTADOR
    document.getElementById('prestadorCpfCnpj').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      
      if (value.length <= 11) {
        // CPF: 000.000.000-00
        if (value.length > 9) {
          value = value.slice(0,3) + '.' + value.slice(3,6) + '.' + value.slice(6,9) + '-' + value.slice(9,11);
        } else if (value.length > 6) {
          value = value.slice(0,3) + '.' + value.slice(3,6) + '.' + value.slice(6);
        } else if (value.length > 3) {
          value = value.slice(0,3) + '.' + value.slice(3);
        }
      } else {
        // CNPJ: 00.000.000/0000-00
        if (value.length > 12) {
          value = value.slice(0,2) + '.' + value.slice(2,5) + '.' + value.slice(5,8) + '/' + value.slice(8,12) + '-' + value.slice(12,14);
        } else if (value.length > 8) {
          value = value.slice(0,2) + '.' + value.slice(2,5) + '.' + value.slice(5,8) + '/' + value.slice(8);
        } else if (value.length > 5) {
          value = value.slice(0,2) + '.' + value.slice(2,5) + '.' + value.slice(5);
        } else if (value.length > 2) {
          value = value.slice(0,2) + '.' + value.slice(2);
        }
        if (value.length > 18) value = value.slice(0, 18);
      }
      
      e.target.value = value;
    });

    // FORMATA√á√ÉO AUTOM√ÅTICA DE CPF/CNPJ - CLIENTE
    document.getElementById('clienteCpfCnpj').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      
      if (value.length <= 11) {
        // CPF: 000.000.000-00
        if (value.length > 9) {
          value = value.slice(0,3) + '.' + value.slice(3,6) + '.' + value.slice(6,9) + '-' + value.slice(9,11);
        } else if (value.length > 6) {
          value = value.slice(0,3) + '.' + value.slice(3,6) + '.' + value.slice(6);
        } else if (value.length > 3) {
          value = value.slice(0,3) + '.' + value.slice(3);
        }
      } else {
        // CNPJ: 00.000.000/0000-00
        if (value.length > 12) {
          value = value.slice(0,2) + '.' + value.slice(2,5) + '.' + value.slice(5,8) + '/' + value.slice(8,12) + '-' + value.slice(12,14);
        } else if (value.length > 8) {
          value = value.slice(0,2) + '.' + value.slice(2,5) + '.' + value.slice(5,8) + '/' + value.slice(8);
        } else if (value.length > 5) {
          value = value.slice(0,2) + '.' + value.slice(2,5) + '.' + value.slice(5);
        } else if (value.length > 2) {
          value = value.slice(0,2) + '.' + value.slice(2);
        }
        if (value.length > 18) value = value.slice(0, 18);
      }
      
      e.target.value = value;
      gerarNumeroOrcamento(); // Gerar n√∫mero do or√ßamento automaticamente
    });
  </script>
</body>
</html>
